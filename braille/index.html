<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>International Braille Day Globe â€“ Prototype</title>
  <!--
    International Braille Day (Jan 4) â€“ Globe Prototype
    Layers: (1) Braille literacy (selected countries), (2) Braille device usage (selected countries), optional overlay (Marrakesh Treaty ratification),
    Points: schools for the blind; pioneers/advancers of braille

    Notes for expansion:
    - Add more country values to the literacy/device datasets below (ISO3 keys).
    - Add more schools/pioneers to the points arrays.

    UX features:
    - Haptic feedback (navigator.vibrate) on interactions
    - Gentle click tone via WebAudio API
    - Info panel with English/Braille toggle + speech synthesis
    - Country search focusing the globe
    - Braille aesthetic background + paper texture

    Data provenance (add more as we expand):
      - USA literacy ~10% of legally blind read Braille; 1960 ~50% (Wikipedia / NFB)
      - France ~15% read; ~10% read+write (Brock & Jouffrais 2015)
      - UK ~7% use Braille (Guardian 2023) â€” use cautiously; adjust if better source
      - Tonga ~2.7% of people with visual difficulties use Braille tools (World Bank/UNICEF Tonga reports)
      - Marrakesh VIP Treaty ratifications: WIPO
  -->
  <style>
    :root{
      --bg:#f6f2e9; /* paper */
      --ink:#232323;
      --ink2:#54525a;
      --accent:#6b5ca5; /* accessible purple */
      --accent-2:#2a7f62; /* teal */
      --panel:rgba(255,255,255,.92);
    }
    html,body{height:100%; margin:0}
    body{
      font-family: "Atkinson Hyperlegible", ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Helvetica Neue", sans-serif;
      background:
        radial-gradient(circle at 20% 15%, rgba(0,0,0,.03), transparent 35%),
        radial-gradient(circle at 80% 85%, rgba(0,0,0,.025), transparent 40%),
        var(--bg);
      color:var(--ink);
      overflow:hidden;
    }
    /* Subtle embossed braille wallpaper saying "International Braille Day" in a tiled SVG */
    body::before{
      content:"";
      position:fixed; inset:0; pointer-events:none; opacity:.25; mix-blend-mode:multiply;
      background-image:url('data:image/svg+xml;utf8,\
      <svg xmlns="http://www.w3.org/2000/svg" width="240" height="140" viewBox="0 0 240 140">\
        <defs>\
          <filter id="emb"><feGaussianBlur stdDeviation=".35"/></filter>\
        </defs>\
        <rect width="240" height="140" fill="none"/>\
        <g fill="%23eae5d7" filter="url(%23emb)">\
          <!-- dot pattern approximating braille cells -->\
          <!-- purely decorative: not intended to be read -->\
          <circle cx="20" cy="20" r="2"/><circle cx="20" cy="30" r="2"/><circle cx="30" cy="20" r="2"/>\
          <circle cx="60" cy="40" r="2"/><circle cx="60" cy="50" r="2"/><circle cx="70" cy="40" r="2"/>\
          <circle cx="100" cy="25" r="2"/><circle cx="100" cy="35" r="2"/><circle cx="110" cy="25" r="2"/>\
          <circle cx="150" cy="60" r="2"/><circle cx="150" cy="70" r="2"/><circle cx="160" cy="60" r="2"/>\
          <circle cx="200" cy="30" r="2"/><circle cx="200" cy="40" r="2"/><circle cx="210" cy="30" r="2"/>\
          <!-- repeat rows -->\
          <use href="#r"/>\
        </g>\
      </svg>');
      background-size:240px 140px; background-repeat:repeat;
    }
    #app{position:fixed; inset:0; display:grid; grid-template-rows:auto 1fr;}
    header{
      display:flex; gap:12px; align-items:center; padding:10px 14px; background:linear-gradient(180deg, rgba(255,255,255,.95), rgba(255,255,255,.6));
      border-bottom:1px solid rgba(0,0,0,.05); backdrop-filter:saturate(120%) blur(4px);
    }
    .title{font-weight:700; letter-spacing:.2px}
    .subtitle{color:var(--ink2); font-size:.92rem}
    .sp{flex:1}
    .control{display:flex; align-items:center; gap:8px;}
    .control label{font-size:.9rem; color:var(--ink2)}
    select,input[type="text"]{padding:8px 10px; border-radius:12px; border:1px solid rgba(0,0,0,.15); background:white}
    button{padding:8px 12px; border-radius:12px; border:1px solid rgba(0,0,0,.15); background:white; cursor:pointer}
    button:hover{background:#fff}
    #globe{position:relative;}
    #globeCanvas{width:100%; height:100%; display:block}

    /* Info panel */
    .panel{position:fixed; right:12px; bottom:12px; width:min(440px, 92vw); max-height:62vh; overflow:auto; background:var(--panel); border-radius:16px; box-shadow:0 8px 24px rgba(0,0,0,.15); padding:12px 14px; outline:2px solid rgba(0,0,0,.05)}
    .panel h3{margin:.2em 0 .4em}
    .panel .meta{font-size:.9rem; color:var(--ink2); margin-bottom:.6em}
    .panel .tools{display:flex; gap:6px; flex-wrap:wrap; margin:.3em 0 .6em}
    .badge{display:inline-block; padding:2px 8px; border-radius:999px; background:#fff; border:1px solid rgba(0,0,0,.08); font-size:.78rem; color:var(--ink2)}
    .braille{font-family:"Apple Braille", "SimBraille", "Braille", ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; letter-spacing:.12em; line-height:1.3}

    .legend{position:fixed; left:12px; bottom:12px; background:var(--panel); padding:10px 12px; border-radius:14px; box-shadow:0 8px 24px rgba(0,0,0,.15); outline:2px solid rgba(0,0,0,.05)}
    .legend h4{margin:.2em 0 .4em}
    .legend .row{display:flex; align-items:center; gap:8px}
    .swatch{width:18px; height:12px; border-radius:3px; border:1px solid rgba(0,0,0,.15)}

    .attribution{position:fixed; left:10px; top:10px; font-size:.8rem; color:var(--ink2)}
    .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; font-size:.85em; padding:.05em .35em; border-radius:6px; border:1px solid rgba(0,0,0,.15); background:#fff}
  </style>
</head>
<body>
  <div id="app" role="application" aria-label="International Braille Day globe map">
    <header>
      <div>
        <div class="title">International Braille Day Globe</div>
        <div class="subtitle">Braille literacy & device usage (prototype) â€¢ Created using Web Mapper GPT</div>
      </div>
      <div class="sp"></div>
      <div class="control" title="Layer">
        <label for="layerSel">Layer</label>
        <select id="layerSel" aria-label="Select data layer">
          <option value="literacy">Braille literacy (selected countries)</option>
          <option value="device">Braille device usage (selected countries)</option>
          <option value="marrakesh">Marrakesh Treaty (ratified)</option>
        </select>
      </div>
      <div class="control" title="Search country">
        <label for="q">Search</label>
        <input id="q" type="text" placeholder="Find a countryâ€¦ (e.g., France)" aria-label="Search for a country" />
        <button id="btnFind" aria-label="Find">Go</button>
      </div>
      <div class="control">
        <button id="btnTogglePoints" aria-pressed="true">Hide points</button>
      </div>
      <div class="control">
        <button id="btnPrefs" aria-expanded="false">Accessibility</button>
      </div>
    </header>
    <div id="globe"><canvas id="globeCanvas" aria-hidden="true"></canvas></div>
  </div>

  <div class="legend" id="legend" aria-live="polite"></div>
  <div class="panel" id="panel" hidden>
    <h3 id="panelTitle">Info</h3>
    <div class="meta" id="panelMeta"></div>
    <div id="panelBody"></div>
    <div class="tools">
      <button id="btnBraille">Show in Braille</button>
      <button id="btnSpeak">ðŸ”Š Speak</button>
      <button id="btnClose">Close</button>
      <span class="badge">tap/click = gentle haptic + tone</span>
    </div>
  </div>
  <div class="attribution">Basemap & country geometry Â© Natural Earth â€¢ Data sources in About â†’ Accessibility â€¢ Attribution: Created using Web Mapper GPT</div>

  <!-- Libraries (ES Modules to avoid deprecation warnings) -->
  <script type="module">
    import * as THREE from 'https://unpkg.com/three@0.160.0/build/three.module.js';
    import ThreeGlobe from 'https://unpkg.com/three-globe@2.30.0/dist/three-globe.module.js';
    import * as topojson from 'https://unpkg.com/topojson-client@3/dist/topojson-client.min.js';

    // =============================
    // Data (seeded; expand as we go)
    // =============================
    const literacyPct = { FRA: 15, USA: 10, GBR: 7 };
    const deviceUsagePct = { TON: 2.7 };
    let marrakeshParties = new Set();

    const schools = [
      { name: 'Perkins School for the Blind', where: 'Watertown, Massachusetts, USA', coords: [42.374, -71.166], url: 'https://www.perkins.org/', type: 'school', note: 'Founded 1829; historic leader in braille education.' },
      { name: 'Royal School for the Blind', where: 'Liverpool, UK', coords: [53.392, -2.946], url: 'https://www.rsblind.org/', type: 'school', note: 'Founded 1791; oldest continuously operating school for the blind.' },
      { name: 'Sri Rakum School for the Blind', where: 'Bengaluru, India', coords: [12.972, 77.594], url: 'https://srakum.org/', type: 'school', note: 'Emphasis on braille literacy and life skills.' }
    ];

    const pioneers = [
      { name: 'Louis Braille (1809â€“1852)', where: 'Coupvray, France', coords: [48.932, 2.806], type: 'pioneer', note: 'Inventor of the six-dot braille system.' },
      { name: 'Charles Barbier (1767â€“1841)', where: 'Valenciennes, France', coords: [50.356, 3.517], type: 'pioneer', note: 'Developed "night writing", an inspiration for braille.' },
      { name: 'Valentin HaÃ¼y (1745â€“1822)', where: 'Paris, France', coords: [48.8566, 2.3522], type: 'pioneer', note: 'Founded the first school for the blind (1784).'},
      { name: 'Samuel Gridley Howe (1801â€“1876)', where: 'Boston, USA', coords: [42.3601, -71.0589], type: 'advancer', note: 'Perkins director; early braille advocate in the U.S.' }
    ];

    // =============================
    // WebGL Globe setup
    // =============================
    const canvas = document.getElementById('globeCanvas');
    const renderer = new THREE.WebGLRenderer({ canvas, antialias:true, alpha:true });

    function resizeRenderer() {
      const headerH = document.querySelector('header').getBoundingClientRect().height || 56;
      const w = window.innerWidth;
      const h = window.innerHeight - headerH;
      renderer.setSize(w, h, false);
      camera.aspect = w / h; camera.updateProjectionMatrix();
    }

    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(45, 2, 0.1, 2000);
    camera.position.z = 400;

    const globe = new ThreeGlobe()
      .hexPolygonsData([]) // placeholder; real fill via polygonsData below
      .hexPolygonResolution(3)
      .hexPolygonMargin(0.3)
      .showAtmosphere(true)
      .atmosphereColor('#8293ff')
      .atmosphereAltitude(0.2);
      // NOTE: .backgroundColor(...) is NOT a ThreeGlobe API; removed to fix error

    const amb = new THREE.AmbientLight(0xffffff, 0.9); scene.add(amb);
    const dir = new THREE.DirectionalLight(0xffffff, 0.7); dir.position.set(1,1,1); scene.add(dir);

    scene.add(globe);

    function animate(){ requestAnimationFrame(animate); globe.rotation.y += 0.0008; renderer.render(scene, camera); }
    animate();

    window.addEventListener('resize', resizeRenderer); resizeRenderer();

    // =============================
    // Load world geometry
    // =============================
    const worldTopo = await fetch('https://unpkg.com/world-atlas@2/countries-110m.json').then(r=>r.json());
    const countries = topojson.feature(worldTopo, worldTopo.objects.countries);

    globe
      .polygonsData(countries.features)
      .polygonCapColor(feat=> colorFor(feat))
      .polygonSideColor(()=> 'rgba(60,60,60,.25)')
      .polygonStrokeColor(()=> 'rgba(40,40,40,.6)')
      .onPolygonClick((feat)=>{ ping(); if('vibrate' in navigator) navigator.vibrate(20); focusCountry(feat); openPanelForCountry(feat); })
      .onPolygonHover((feat)=>{ document.body.style.cursor = feat ? 'pointer' : 'default'; });

    const pointData = [
      ...schools.map(s=> ({...s, lat:s.coords[0], lng:s.coords[1]})),
      ...pioneers.map(p=> ({...p, lat:p.coords[0], lng:p.coords[1]}))
    ];

    globe
      .pointsData(pointData)
      .pointAltitude(p=> p.type==='school' ? 0.01 : 0.02)
      .pointRadius(p=> p.type==='school' ? 0.6 : 0.8)
      .pointColor(p=> p.type==='school' ? '#2a7f62' : '#6b5ca5')
      .onPointClick((p)=>{ ping(); if('vibrate' in navigator) navigator.vibrate(20); openPanelForPoint(p); });

    updateLegend();

    // Controls
    document.getElementById('layerSel').addEventListener('change', ()=>{ updateLegend(); globe.polygonsData(globe.polygonsData()); });
    document.getElementById('btnFind').addEventListener('click', doSearch);
    document.getElementById('q').addEventListener('keydown', e=>{ if(e.key==='Enter') doSearch(); });
    document.getElementById('btnTogglePoints').addEventListener('click', ()=>{
      const cur = globe.pointsData();
      if(cur && cur.length){ globe.pointsData([]); document.getElementById('btnTogglePoints').textContent='Show points'; }
      else { globe.pointsData(pointData); document.getElementById('btnTogglePoints').textContent='Hide points'; }
    });
    document.getElementById('btnPrefs').addEventListener('click', ()=>{
      const msg = `Accessibility options:

â€¢ Haptics: ${('vibrate' in navigator) ? 'supported' : 'not supported'}
â€¢ Speech synthesis: ${('speechSynthesis' in window) ? 'supported' : 'not supported'}

Shortcuts:
â€¢ Drag to rotate globe
â€¢ Scroll or pinch to zoom
â€¢ Search: type country name and press Enter`;
      alert(msg);
    });

    function doSearch(){
      const term = (document.getElementById('q').value||'').trim().toLowerCase();
      if(!term) return;
      const feat = countries.features.find(f=> (f.properties.name||'').toLowerCase()===term);
      if(feat){ focusCountry(feat); openPanelForCountry(feat); ping(); if('vibrate' in navigator) navigator.vibrate(15); }
      else alert('Country not found (exact match). Try full official name.');
    }

    function focusCountry(feat){
      const c = centroidOf(feat);
      globe.pointOfView({ lat:c[1], lng:c[0], altitude: 1.8 }, 900);
    }

    function centroidOf(feat){
      const b = bbox(feat);
      return [(b[0]+b[2])/2, (b[1]+b[3])/2];
    }

    function bbox(feat){
      let minX= 180, minY= 90, maxX=-180, maxY=-90;
      const coords = feat.geometry.type === 'MultiPolygon' ? feat.geometry.coordinates.flat(2) : feat.geometry.coordinates[0];
      coords.flat(Infinity).forEach((v,i,arr)=>{
        if(typeof v==='number' && (i%2===0)){
          const x=v, y=arr[i+1];
          if(x<minX) minX=x; if(x>maxX) maxX=x; if(y<minY) minY=y; if(y>maxY) maxY=y;
        }
      });
      return [minX,minY,maxX,maxY];
    }

    function colorFor(feat){
      const layer = document.getElementById('layerSel').value;
      const name = feat.properties.name;
      const iso3 = guessISO3(name);
      if(layer==='literacy'){
        const v = literacyPct[iso3];
        return v==null ? 'rgba(200,200,200,.35)' : scaleSeqPurple(v);
      }
      if(layer==='device'){
        const v = deviceUsagePct[iso3];
        return v==null ? 'rgba(200,200,200,.35)' : scaleSeqTeal(v);
      }
      if(layer==='marrakesh'){
        return marrakeshParties.has(iso3) ? 'rgba(107,92,165, .75)' : 'rgba(200,200,200,.25)';
      }
      return 'rgba(200,200,200,.35)';
    }

    function scaleSeqPurple(v){ const t = Math.max(0, Math.min(1, v/20)); const a = 0.25 + 0.55*t; return `rgba(107, 92, 165, ${a.toFixed(3)})`; }
    function scaleSeqTeal(v){ const t = Math.max(0, Math.min(1, v/10)); const a = 0.25 + 0.55*t; return `rgba(42, 127, 98, ${a.toFixed(3)})`; }

    function updateLegend(){
      const layer = document.getElementById('layerSel').value;
      const el = document.getElementById('legend');
      if(layer==='literacy'){
        el.innerHTML = `<h4>Braille literacy (% of blind people who read braille)</h4>
          <div class="row"><span class="swatch" style="background:rgba(107,92,165,.25)"></span> ~0%</div>
          <div class="row"><span class="swatch" style="background:rgba(107,92,165,.55)"></span> ~10%</div>
          <div class="row"><span class="swatch" style="background:rgba(107,92,165,.85)"></span> ~20%+</div>
          <div class="row"><span class="badge">Gray = data not yet compiled</span></div>`;
      } else if(layer==='device'){
        el.innerHTML = `<h4>Device usage (% using braille tools)</h4>
          <div class="row"><span class="swatch" style="background:rgba(42,127,98,.25)"></span> ~0%</div>
          <div class="row"><span class="swatch" style="background:rgba(42,127,98,.55)"></span> ~5%</div>
          <div class="row"><span class="swatch" style="background:rgba(42,127,98,.85)"></span> ~10%+</div>
          <div class="row"><span class="badge">Gray = data not yet compiled</span></div>`;
      } else {
        el.innerHTML = `<h4>Marrakesh Treaty</h4>
          <div class="row"><span class="swatch" style="background:rgba(107,92,165,.8)"></span> Party</div>
          <div class="row"><span class="swatch" style="background:rgba(200,200,200,.35)"></span> Not party / not compiled</div>`;
      }
    }

    const panel = document.getElementById('panel');
    const panelTitle = document.getElementById('panelTitle');
    const panelMeta = document.getElementById('panelMeta');
    const panelBody = document.getElementById('panelBody');
    document.getElementById('btnClose').onclick = ()=> panel.hidden = true;
    document.getElementById('btnBraille').onclick = ()=>{
      const was = panelBody.dataset.mode||'en';
      if(was==='en'){ panelBody.dataset.mode='brl'; panelBody.classList.add('braille'); panelBody.textContent = toBraille(panelBody.dataset.enText||panelBody.textContent); }
      else { panelBody.dataset.mode='en'; panelBody.classList.remove('braille'); panelBody.textContent = panelBody.dataset.enText || panelBody.textContent; }
    };
    document.getElementById('btnSpeak').onclick = ()=>{
      if(!('speechSynthesis' in window)) return alert('Speech synthesis not supported.');
      const u = new SpeechSynthesisUtterance(panelBody.dataset.enText || panelBody.textContent);
      u.lang = 'en-US'; u.rate=1; u.pitch=1; window.speechSynthesis.cancel(); window.speechSynthesis.speak(u);
    };

    function openPanelForCountry(feat){
      const name = feat.properties.name; const iso3 = guessISO3(name); const layer = document.getElementById('layerSel').value;
      let body='';
      if(layer==='literacy'){ const v = literacyPct[iso3]; body = v!=null ? `${name}: estimated ${v.toFixed(1)}% of blind people read braille (prototype value).` : `${name}: no vetted figure in the prototype dataset yet.`; }
      else if(layer==='device'){ const v = deviceUsagePct[iso3]; body = v!=null ? `${name}: ~${v.toFixed(1)}% of people with visual difficulties use braille tools (prototype value).` : `${name}: no vetted figure in the prototype dataset yet.`; }
      else { const party = marrakeshParties.has(iso3); body = party ? `${name} is a Party to the Marrakesh Treaty to facilitate access to published works for persons who are blind, visually impaired, or otherwise print disabled.` : `${name}: not listed as a Party in the current prototype list.`; }
      panelTitle.textContent = name; panelMeta.textContent = `Layer: ${document.getElementById('layerSel').selectedOptions[0].text}`; panelBody.dataset.enText = body; panelBody.dataset.mode='en'; panelBody.classList.remove('braille'); panelBody.textContent = body; panel.hidden = false;
    }

    function openPanelForPoint(p){
      panelTitle.textContent = p.name; panelMeta.textContent = `${p.type==='school'?'School':'Pioneer'} â€¢ ${p.where}`; const body = p.note + (p.url?`

Website: ${p.url}`:''); panelBody.dataset.enText = body; panelBody.dataset.mode='en'; panelBody.classList.remove('braille'); panelBody.textContent = body; panel.hidden = false;
    }

    const brailleMap = (()=>{ const m={}; const base=0x2800; const pat={a:1, b:3, c:9, d:25, e:17, f:11, g:27, h:19, i:10, j:26, k:5, l:7, m:13, n:29, o:21, p:15, q:31, r:23, s:14, t:30, u:37, v:39, w:58, x:45, y:61, z:53}; Object.entries(pat).forEach(([ch,bits])=> m[ch]=String.fromCharCode(base+bits)); m[' ']=' '; m['.']=String.fromCharCode(base+2); m[',']=String.fromCharCode(base+2); return m; })();
    function toBraille(s){ return s.toLowerCase().split('').map(ch=> brailleMap[ch]||ch).join(''); }

    let ctx; function ping(){
      try{
        if(!ctx){ const AC = window.AudioContext||window.webkitAudioContext; if(!AC) return; ctx = new AC(); }
        if(ctx.state==='suspended') ctx.resume();
        const o = ctx.createOscillator(); const g = ctx.createGain(); o.frequency.value = 660; o.type='sine'; o.connect(g); g.connect(ctx.destination);
        g.gain.setValueAtTime(0.0001, ctx.currentTime); g.gain.exponentialRampToValueAtTime(0.05, ctx.currentTime+0.01); g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+0.12);
        o.start(); o.stop(ctx.currentTime+0.13);
      }catch(e){ /* ignore */ }
    }

    function guessISO3(name){
      const map = new Map([
        ['France','FRA'], ['United States of America','USA'], ['United States','USA'], ['United Kingdom','GBR'], ['Tonga','TON'], ['India','IND'], ['Australia','AUS'], ['Argentina','ARG']
      ]);
      return map.get(name)||'UNK';
    }

    // Seed a few Marrakesh parties (extend with full list later)
    marrakeshParties = new Set(['FRA','USA','GBR','IND','AUS','ARG','ARM','AFG']);

  </script>
</body>
</html>
